<!-- Imports polymer -->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-input/paper-textarea.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-spinner/paper-spinner.html">

<script src="peptideMassCalculator.js"></script>
<script src="glycanMassCalculator.js"></script>

<!-- Defines element markup -->
<dom-module id="glycopeptide-dataset-generator">
    <style>
        :root {
            --paper-input-container-input: {
                border: solid #f7f7f9 .1rem;
                height: 5em;

            };

            --paper-input-container-label:{
                padding-bottom: 10px;
                font-size: 22px;
                line-height: 28px;
            };

            /* Label and underline color when the input is focused */
            --paper-input-container-focus-color: blue;

            /* Label and underline color when the input is invalid */
            --paper-input-container-invalid-color: red;

            /* Input foreground color */
            --paper-input-container-input-color: black;

            --paper-spinner-stroke-width: 4px;
        }

        paper-spinner {
            top: 70px;
            left: 43.5%;
            height: 80px;
            width: 80px;
            position: absolute;
            z-index: 10;
        }

        paper-textarea {
            min-width: 300px;
            width: 42%;
            display: inline-block;
            margin: 30px 0px 0px 40px;
        }

        .paper-textarea input {
            height: 5em;
        }

        paper-button.indigo {
            font-family: "Roboto";
            background-color: var(--paper-indigo-500);
            color: white;
            margin-left: 40px;
            vertical-align: 70%;
            --paper-button-raised-keyboard-focus: {
                background-color: var(--paper-indigo-a300) !important;
                color: white !important;
            };
        }

        paper-dialog {
            position: fixed;
            text-align: center;
            margin: 30px;
            width: auto;
            height: auto;
            overflow: auto;
        }
    </style>
    <template>
        <div class="fit">
            <form is="iron-form" id="newDatasetForm">
                <paper-textarea name="peptideList" label="List of peptides" value="{{peptides}}"></paper-textarea>
                <paper-textarea name="glycanList" label="List of glycan compositions" value="{{glycans}}"></paper-textarea>
                <paper-button raised class="indigo" on-click="generate">generate</paper-button>
                <paper-dialog id="dialog"></paper-dialog>
            </form>
        </div>
        <paper-spinner id="spinner" alt="Generating dataset" disabled></paper-spinner>
    </template>

    <!-- Registers custom element -->
    <script>
        Polymer({
            is: 'glycopeptide-dataset-generator',
            properties: {
                peptides: {
                    type: Array,
                    value: []
                },
                glycans: {
                    type: Array,
                    value: []
                },
                glycopeptides: {
                    type: Object,
                    notify: true,
                    readOnly: false
                },
                datasetLength: Number
            },
            generate: function() {
                this.$.spinner.active = true;
                if(typeof this.peptides === 'string'){
                    var peptideList = this.peptides.split(",");
                    for(var i=0; i<peptideList.length; i++){peptideList[i] = peptideList[i].trim()};

                    var nonRedundantPeptideList = peptideList.filter(function(item, pos) {
                        return peptideList.indexOf(item) == pos;
                    });

                    this.peptides = nonRedundantPeptideList;
                }

                if(typeof this.glycans === 'string'){
                    var glycanList = this.glycans.split(",").filter(String);
                    for(var i=0; i<glycanList.length; i++){glycanList[i] = glycanList[i].trim()};

                    var nonRedundantGlycanList = glycanList.filter(function(item, pos) {
                        return glycanList.indexOf(item) == pos;
                    });

                    this.glycans = nonRedundantGlycanList;
                }

                if(this.glycans.length*this.peptides.length>10000000){
                    this.$.dialog.innerHTML =
                        "<h2>The dataset generator has a limit of 10 000 000 combinations."
                        +" Please reduce list of peptides and/or glycans.</h2>";
                    this.$.dialog.open();
                    this.$.spinner.active = false;
                }else{
                    this.combineGlycansAndPeptides();
                }
            },
            combineGlycansAndPeptides: function() {
                glycopeptides = {};
                glycanMasses = {};
                for (glycan of this.glycans){
                    glycanMasses[glycan] = getGlycanMolecularMass(glycan);
                }
                this.datasetLength =0;
                for(peptide of this.peptides){
                    if(peptide.toUpperCase().match(/N[^P][ST]/) || parseFloat(peptide)) {
                        peptideMass = getPeptideMolecularMass(peptide);
                        for (glycan of this.glycans){
                            glycanMass = glycanMasses[glycan];
                            glycopeptideMass = peptideMass+glycanMass;
                            bucket = Math.round(glycopeptideMass*10);
                            if(!glycopeptides[bucket]){
                                glycopeptides[bucket] = [];
                            }
                            glycopeptides[bucket].push(new Array(peptide, glycan, glycopeptideMass));
                            this.datasetLength+=1;
                        }
                    }
                }
                this.glycopeptides = glycopeptides;
                this.$.spinner.active = false;
            }
        });
    </script>
</dom-module>
