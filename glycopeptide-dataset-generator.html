<!-- Imports polymer -->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-input/paper-textarea.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-spinner/paper-spinner.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">

<script src="peptideMassCalculator.js"></script>
<script src="glycanMassCalculator.js"></script>

<!-- Defines element markup -->
<dom-module id="glycopeptide-dataset-generator">
    <style is="custom-style" include="iron-flex iron-flex-alignment"></style>
    <style>
        :root {
            --paper-input-container-input: {
                border: solid #f7f7f9 .1rem;
            };

            --paper-input-container-label:{
                padding-bottom: 10px;
                font-size: 22px;
                line-height: 28px;
            };

            /* Label and underline color when the input is focused */
            --paper-input-container-focus-color: blue;

            /* Label and underline color when the input is invalid */
            --paper-input-container-invalid-color: red;

            /* Input foreground color */
            --paper-input-container-input-color: black;

            --paper-spinner-stroke-width: 4px;
        }

        paper-spinner {
            top: 70px;
            left: 43.5%;
            height: 80px;
            width: 80px;
            /*position: absolute;*/
            z-index: 10;
        }

        paper-button.indigo {
            font-family: "Roboto";
            background-color: var(--paper-indigo-500);
            color: white;
            margin-top: 60px;
            --paper-button-raised-keyboard-focus: {
                background-color: var(--paper-indigo-a300) !important;
                color: white !important;
            };
        }

        paper-checkbox {
            margin-left: 10px;
            margin-top: 10px;
        }

        paper-dialog {
            position: fixed;
            text-align: center;
            margin: 30px;
            width: auto;
            height: auto;
            overflow: auto;
        }

        paper-input {
            margin-top: 40px;
            min-width: 450px;
        }

        .fileInput {
            min-width: 450px;
        }

        .mainContainerForm {
            border: 1px solid black;
            margin-left: 36px;
            margin-right: 48px;
            padding-left: 20px;
            padding-right: 20px;
            padding-bottom: 15px;
            min-width: 760px;
        }

        .sectionHeading {
            font-family: 'Roboto', 'Noto', 'sans-serif';
            -webkit-font-smoothing: antialiased;
            font-weight: 400;
            font-size: 17px;
            font-height: 23px;
            padding-bottom: 10px;
            padding-top: 25px;
            -webkit-margin-before: 1em;
            -webkit-margin-after: 0em;
        }

        .modifcationsBox{
            width: 300px;
            margin: 10px 20px 10px 20px;

        }
    </style>
    <template>
        <iron-ajax
            id="unicarbAjax"
            auto
            handle-as="text"
            on-response="loadUnicarbKbComposition">
        </iron-ajax>
        <div class="mainContainerForm">
            <form is="iron-form" id="newDatasetForm">
                <div class="layout horizontal justified wrap">
                    <div class="fileInput layout vertical widthInput">
                        <paper-input type=file label="List of peptides" on-change="loadPeptideFile"></paper-input>
                        <paper-checkbox id="filterNSites" checked={{nSitesFilter}}>Filter peptides containing N-glycosite sequence motif</paper-checkbox>
                        <paper-checkbox id="filterOSites" checked={{oSitesFilter}}>Filter peptides containing at least one Ser/Thr residue</paper-checkbox>
                    </div>
                    <div class="fileInput layout vertical widthInput">
                        <paper-input type="file" label="List of glycans" on-change="loadGlycanFile"></paper-input>
                        <paper-checkbox id="unicarbKBNGlycans" checked={{unicarbKBNGlycan}}> Use UnicarbKB N-glycans</paper-checkbox>
                        <paper-checkbox id="unicarbKBAll" checked={{unicarbKBAll}}> Use UnicarbKB</paper-checkbox>
                    </div>
                    <div class="layout end-justified">
                        <paper-button raised class="indigo" id="submit" on-click="generate">generate</paper-button>
                    </div>
                    <paper-dialog id="dialog"></paper-dialog>
                </div>
                <div class="layout vertical">
                    <div class="sectionHeading">Fixed modifications</div>
                    <div class="modificationsBox layout horizontal justified wrap">
                        <div class="layout vertical">
                            <paper-checkbox id="acetylationK" checked={{acetylationK}}> Acetylation (K)</paper-checkbox>
                            <paper-checkbox id="acetylationNterm" checked={{acetylationNterm}}> Acetylation (N-term)</paper-checkbox>
                        </div>
                        <div class="layout vertical">
                            <paper-checkbox id="amidatedCterm" checked={{amidatedCterm}}> Amidated (C-term)</paper-checkbox>
                            <paper-checkbox id="carbamidomethylationC" checked={{carbamidomethylationC}}> Carbamidomethylation (C)</paper-checkbox>
                        </div>
                        <div class="layout vertical">
                            <paper-checkbox id="carbamylK" checked={{carbamylK}}> Carbamyl (K)</paper-checkbox>
                            <paper-checkbox id="deamidatedNQ" checked={{deamidatedNQ}}> Deaminated (NQ)</paper-checkbox>
                        </div>
                        <div class="layout vertical">
                            <paper-checkbox id="oxidationM" checked={{oxidationM}}> Oxidation (M)</paper-checkbox>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <paper-spinner name="spinner" id="spinner" alt="Generating dataset"></paper-spinner>
    </template>

    <!-- Registers custom element -->
    <script>
        Polymer({
            is: 'glycopeptide-dataset-generator',
            properties: {
                peptides: {
                    type: Array,
                    value: []
                },
                glycans: {
                    type: Array,
                    value: []
                },
                glycansUnicarb: {
                    type: Array,
                    value: []
                },
                glycopeptides: {
                    type: Object,
                    notify: true,
                    readOnly: false
                },
                unicarbKBNGlycan: {
                    type: Boolean,
                    value: false,
                    observer: "_loadUnicarbNGlycan"
                },
                unicarbKBAll: {
                    type: Boolean,
                    value: false,
                    observer: "_loadUnicarbAll"
                },
                nSitesFilter: {
                    type: Boolean,
                    value: true
                },
                oSitesFilter: {
                    type: Boolean,
                    value: false
                },
                fixedModifications: {
                    type: Array,
                    value: []
                },
                acetylationK: {
                    type: Boolean,
                    value: false
                },
                acetylationNterm: {
                    type: Boolean,
                    value: false
                },
                amidatedCterm: {
                    type: Boolean,
                    value: false
                },
                carbamidomethylationC: {
                    type: Boolean,
                    value: false
                },
                carbamylK: {
                    type: Boolean,
                    value: false
                },
                deamidatedNQ: {
                    type: Boolean,
                    value: false
                },
                oxidationM: {
                    type: Boolean,
                    value: false
                },
                datasetLength: Number
            },
            addFixedModifications: function() {
                if (this.acetylationK){
                    this.fixedModifications.push(['K','K[+42.010565]']);
                }
                if (this.acetylationNterm){
                    this.fixedModifications.push(['Nterm','[+42.010565]']);
                }
                if (this.amidatedCterm){
                    this.fixedModifications.push(['Cterm','[-0.9840]']);
                }
                if (this.carbamidomethylationC){
                    this.fixedModifications.push(['C','C[+57.021464]']);
                }
                if (this.carbamylK){
                    this.fixedModifications.push(['K','K[+43.00581]']);
                }
                if (this.deamidatedNQ){
                    this.fixedModifications.push(['N','N[+0.9840]']);
                    this.fixedModifications.push(['Q','Q[+0.9840]']);
                }
                if (this.oxidationM){
                    this.fixedModifications.push(['M','M[+15.9949]']);
                }
                for (var mod in this.fixedModifications){
                    if (this.fixedModifications[mod][0]=='Nterm'){
                        for (var idx in this.peptides){
                            if (!this.peptides[idx].startsWith(this.peptides[idx].substr(0,1)+this.fixedModifications[mod][1])){
                                this.peptides[idx] = this.peptides[idx].substr(0,1)+this.fixedModifications[mod][1]+this.peptides[idx].substr(1);
                            }
                        }
                    }else if(this.fixedModifications[mod][0]=='Cterm'){
                        for (var idx in this.peptides) {
                            if (!this.peptides[idx].endsWith(this.fixedModifications[mod][1])) {
                                this.peptides[idx] = this.peptides[idx] + this.fixedModifications[mod][1];
                            }
                        }
                    }else{
                        for (idx in this.peptides) {
                            if (this.peptides[idx].indexOf(this.fixedModifications[mod][1])===-1) {
                                this.peptides[idx] = this.peptides[idx].replace(this.fixedModifications[mod][0], this.fixedModifications[mod][1])
                            };
                        }
                    }
                }
            },
            attached: function(){
                if (!(window.File && window.FileReader && window.FileList && window.Blob)) {
                    alert('The File APIs are not fully supported in this browser.');
                }
            },
            _loadUnicarbNGlycan: function(){
                if(this.unicarbKBNGlycan){
                    this.unicarbKBAll=false;
                    this.$.unicarbAjax.url = this.resolveUrl('unicarbKB/compositions-nglycans.txt');
                }
            },
            _loadUnicarbAll: function(){
                if(this.unicarbKBAll){
                    this.unicarbKBNGlycan=false;
                    this.$.unicarbAjax.url = this.resolveUrl('unicarbKB/compositions-all.txt');
                }
            },
            loadGlycanFile: function(evt){
                var file = evt.target.files[0];
                var reader = new FileReader();
                var data=this;
                reader.onload = (function(theFile) {
                    return function(e) {

                        var glycanList = e.target.result.split(",").filter(String);
                        for(var i=0; i<glycanList.length; i++){glycanList[i] = glycanList[i].trim()};

                        var nonRedundantGlycanList = glycanList.filter(function(item, pos) {
                            return glycanList.indexOf(item) == pos;
                        });
                        data.glycans =nonRedundantGlycanList;
                    };
                })(file);
                reader.readAsText(file);
            },
            loadPeptideFile: function(evt){
                var file = evt.target.files[0];
                var reader = new FileReader();
                var data=this;
                reader.onload = (function(theFile) {
                    return function(e) {

                        var peptideList = e.target.result.split(",");
                        for(var i=0; i<peptideList.length; i++){peptideList[i] = peptideList[i].trim()};

                        var nonRedundantPeptideList = peptideList.filter(function(item, pos) {
                            return peptideList.indexOf(item) == pos;
                        });

                        data.peptides = nonRedundantPeptideList;
                    };
                })(file);
                reader.readAsText(file);
            },
            loadDatasetFile: function(evt){
                var file = evt.target.files[0];
                var reader = new FileReader();
                var data = this;
                reader.onload = (function(theFile) {
                    return function(e) {
                        data.glycopeptides = e.target.result;
                    };
                })(file);
                reader.readAsText(file);
            },

            loadUnicarbKbComposition: function(request) {
                var glycanList = request.detail.response.split(",").filter(String);
                for(var i=0; i<glycanList.length; i++){glycanList[i] = glycanList[i].trim()};
                var nonRedundantGlycanList = glycanList.filter(function(item, pos) {
                    return glycanList.indexOf(item) == pos;
                });
                this.glycansUnicarb = nonRedundantGlycanList;
            },

            generate: function() {
                this.$.spinner.active = true;
                if(this.$.unicarbKBAll.checked || this.$.unicarbKBNGlycans.checked){
                    this.glycans = this.glycansUnicarb;
                }
                if(this.glycans.length*this.peptides.length>10000000){
                    this.$.dialog.innerHTML =
                        "<h2>The dataset generator has a limit of 10 000 000 combinations."
                        +" Please reduce list of peptides and/or glycans.</h2>";
                    this.$.dialog.open();
                    this.$.spinner.active = false;
                }else{
                    this.addFixedModifications();
                    this.combineGlycansAndPeptides();
                }
            },
            combineGlycansAndPeptides: function() {
                glycopeptides = {};
                glycanMasses = {};
                for (glycan of this.glycans){
                    glycanMasses[glycan] = getGlycanMolecularMass(glycan);
                }
                this.datasetLength =0;
                for(peptide of this.peptides){
                    if(((!this.nSitesFilter && !this.oSitesFilter)
                        || this.nSitesFilter && peptide.toUpperCase().match(/N[^P][ST]/))
                        || (this.oSitesFilter && peptide.toUpperCase().match(/[ST]/))
                        || parseFloat(peptide)) {
                        peptideMass = getPeptideMolecularMass(peptide);
                        for (glycan of this.glycans){
                            glycanMass = glycanMasses[glycan];
                            glycopeptideMass = peptideMass+glycanMass;
                            bucket = Math.round(glycopeptideMass*10);
                            if(!glycopeptides[bucket]){
                                glycopeptides[bucket] = [];
                            }
                            glycopeptides[bucket].push(new Array(peptide, glycan, glycopeptideMass));
                            this.datasetLength+=1;
                        }
                    }
                }
                this.glycopeptides = glycopeptides;
                this.$.spinner.active = false;
            }
        });
    </script>
</dom-module>
