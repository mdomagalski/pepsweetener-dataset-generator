<!-- Imports polymer -->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-input/paper-textarea.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-header-panel/paper-header-panel.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-spinner/paper-spinner.html">

<script src="peptideMassCalculator.js"></script>
<script src="glycanMassCalculator.js"></script>

<!-- Defines element markup -->
<dom-module id="glycopeptide-dataset-generator">
    <style>
        :root {
            --paper-input-container-input: {
                border: solid #f7f7f9 .1rem;
                height: 5em;

            };

            --paper-input-container-label:{
                padding-bottom: 10px;
                font-size: 22px;
                line-height: 28px;
            };

            /* Label and underline color when the input is focused */
            --paper-input-container-focus-color: blue;

            /* Label and underline color when the input is invalid */
            --paper-input-container-invalid-color: red;

            /* Input foreground color */
            --paper-input-container-input-color: black;
        }
/*        paper-input {
            min-width: 200px;
            width: 200px;
            display: inline-block;
            margin: 20px 10px 30px 80px;
        }*/
        paper-header-panel {
            --paper-header-panel-shadow: {
                height: 6px;
                bottom: -6px;
                box-shadow: inset 0px 5px 6px -3px rgba(0, 0, 0, 0.4);
            };
            --paper-header-panel-standard-container: {
                border: 1px solid gray;
            };
        }

        paper-textarea {
            min-width: 300px;
            width: 42%;
            display: inline-block;
            margin: 20px 10px 30px 40px;
        }
        .paper-textarea input {
            height: 5em;
        }
        paper-button.indigo {
            font-family: "Roboto";
            background-color: var(--paper-indigo-500);
            color: white;
            position: absolute;
            top: 50%;
            margin-left: 40px;
            --paper-button-raised-keyboard-focus: {
                background-color: var(--paper-indigo-a300) !important;
                color: white !important;
            };
        }

        paper-header-panel {
            height: 240px;
            margin: 12px;
            @apply(--shadow-elevation-2dp);
        }

        .paper-header {
            font-family: "Roboto";
            height: 60px;
            font-size: 20px;
            line-height: 60px;
            padding: 0 10px;
            color: white;
            transition: height 0.2s;
        }
        .blue .paper-header {
            background-color: var(--paper-indigo-500);
        }
        paper-dialog {
            position: fixed;
            text-align: center;
            top: 16px;
            margin: 30px;
            width: auto;
            height: auto;
            overflow: auto;
        }
    </style>
    <template>
        <paper-header-panel class="blue" mode="standard" at-top>
            <div class="paper-header">Generate N-glycopeptide dataset</div>
            <div class="fit">
                <form is="iron-form" id="newDatasetForm">
                    <paper-textarea name="peptideList" label="List of peptides" value="{{peptides}}"></paper-textarea>
                    <paper-textarea name="glycanList" label="List of glycan compositions" value="{{glycans}}"></paper-textarea>
                    <paper-button raised class="indigo" on-click="generate">generate</paper-button>
                </form>
            </div>
        </paper-header-panel>
        <paper-spinner alt="Generating dataset"></paper-spinner>
        <paper-dialog id="workingDialog">
            <paper-spinner alt="Generating dataset" active>Generating theoretical glycopeptide dataset</paper-spinner>
        </paper-dialog>
        <paper-dialog id="finishedDialog"></paper-dialog>
    </template>

    <!-- Registers custom element -->
    <script>
    Polymer({
        is: 'glycopeptide-dataset-generator',
        properties: {
            datasetId: String,
            peptides: {
                type: Array,
                value: []
            },
            glycans: {
                type: Array,
                value: []
            },
            glycopeptides: {
                type: Array,
                value: {}
            }
        },
        generate: function() {
            this.glycopeptides = {};
            if(typeof this.peptides === 'string'){
                var peptideList = this.peptides.split(",");
                for(var i=0; i<peptideList.length; i++){peptideList[i] = peptideList[i].trim()};

                var nonRedundantPeptideList = peptideList.filter(function(item, pos) {
                    return peptideList.indexOf(item) == pos;
                });

                this.peptides = nonRedundantPeptideList;
            }

            if(typeof this.glycans === 'string'){
                var glycanList = this.glycans.split(",").filter(String);
                for(var i=0; i<glycanList.length; i++){glycanList[i] = glycanList[i].trim()};

                var nonRedundantGlycanList = glycanList.filter(function(item, pos) {
                    return glycanList.indexOf(item) == pos;
                });

                this.glycans = nonRedundantGlycanList;
            }

            this.combineGlycansAndPeptides();
        },
        combineGlycansAndPeptides: function() {
            this.$.workingDialog.open();
            for(peptide of this.peptides){
                peptideMass = getPeptideMolecularMass(peptide);
                for (glycan of this.glycans){
                    glycanMass = getGlycanMolecularMass(glycan);
                    glycopeptideMass = peptideMass+glycanMass;
                    bucket = Math.round(glycopeptideMass*10);
                    if(!this.glycopeptides[bucket]){
                        this.glycopeptides[bucket] = [];
                    }
                    this.glycopeptides[bucket].push(new Array(peptide, glycan, glycopeptideMass));
                }
            }
            this.$.workingDialog.close();
            this.$.finishedDialog.innerHTML =
                "<h2>You have generated a dataset containing "+Object.keys(this.glycopeptides).length+" theoretical glycopeptides</h2>";
            this.$.finishedDialog.open();
        }
    });
    </script>
</dom-module>
